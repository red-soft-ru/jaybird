stages:
- prepare
- build_and_test
- deploy

cache:
  paths:
    - .m2/repository/
    - target/

variables:
  RELEASE_HUB_PROJECT: jaybird
  CI_URL: ${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}
  TAG_BRANCH: branch_4_0
  MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode -U"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  RDB2_VERSION: "2.6.0.13508"
  RDB3_VERSION: "3.0.5.354"
  RDB4_VERSION: "4.0.0.2459"
  http_proxy: http://git.red-soft.biz:3128
  https_proxy: http://git.red-soft.biz:3128
  no_proxy: localhost,172.0.0.0/8,127.0.0.0/8,.red-soft.biz

.prepare_template: &prepare_template
  tags:
    - docker
    - builder
  stage: prepare
  image: openjdk:8-jdk-alpine
  script:
    - mkdir .ci
    - echo ${VERSION} > .ci/version
    - echo ${BRANCH} > .ci/branch
    - echo ${CONTEXT} > .ci/context
    - mvn $MAVEN_CLI_OPTS releasehub-build:register -Pdeploy-internal -DreleaseHubBuildOnlyCreate -DreleaseHubBuildVersion=$VERSION -DreleaseHubBuildContext=${CONTEXT} -DreleaseHubBuildBranch=${BRANCH} -DreleaseHubBuildCommit=${CI_COMMIT_SHA} -DreleaseHubBuildCIURL=${CI_URL}
  artifacts:
    expire_in: 1 day
    paths:
      - .ci/

prepare:snapshot:
  <<: *prepare_template
  before_script:
    - apk --update add maven
    - REAL_VERSION=$(mvn $MAVEN_CLI_OPTS -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.3.1:exec)
    - VERSION=$(mvn $MAVEN_CLI_OPTS -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.3.1:exec|sed 's/\(.*\)-.*/\1/')
    - "[ \"$REAL_VERSION\" = \"${VERSION}-SNAPSHOT\" ] || (echo Stopping build. Expected ${VERSION}-SNAPSHOT version. Create tag for this commit!; exit 1)"
    - export BUILDNO=$(mvn $MAVEN_CLI_OPTS -q --non-recursive releasehub-build:buildno -Pdeploy-internal -DreleaseHubBuildVersion=${VERSION}-SNAPSHOT)
    - export VERSION=${VERSION}-SNAPSHOT.${BUILDNO}
    - export BRANCH=${CI_COMMIT_REF_NAME}
    - export CONTEXT=commit
  except:
    - tags

prepare:release:
  <<: *prepare_template
  before_script:
    - apk --update add maven
    - VERSION_IN_POM=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.3.1:exec)
    - export VERSION=$(echo ${CI_COMMIT_TAG}|sed 's/v//')
    - export BRANCH=${TAG_BRANCH}
    - export CONTEXT=tag
    - "[ \"$VERSION\" = \"$VERSION_IN_POM\" ] || (echo Project version in pom.xml and tag do not match!; exit 1)"
  only:
    - tags

.deploy_template: &deploy_template
  image: openjdk:8-jdk-alpine
  tags:
    - docker
    - builder
  stage: deploy
  before_script:
    - export VERSION=`cat .ci/version`
    - export BRANCH=`cat .ci/branch`
    - export CONTEXT=`cat .ci/context`
    - apk --update add maven

.build_and_test_template: &build_and_test_template
  tags:
    - docker
    - tester
  stage: build_and_test
  before_script:
    - |
        echo | sudo tee /etc/yum.repos.d/bellsoft.repo > /dev/null << EOF
        [BellSoft]
        name=BellSoft Repository
        baseurl=https://yum.bell-sw.com
        enabled=1
        gpgcheck=1
        gpgkey=https://download.bell-sw.com/pki/GPG-KEY-bellsoft
        priority=1
        EOF
    - echo proxy=$http_proxy >> /etc/yum.conf
    - yum install -y maven krb5-server krb5-workstation expect $EXTRA_DEPENDENCIES
    - /opt/cprocsp/sbin/amd64/cpconfig -license -set $LICENSE_CRYPTOPRO4
    - ./ci/configure_kerberos.sh
    - export VERSION=`cat .ci/version`
    - ln -s `update-alternatives --display jre_11_openjdk | sed -n '2p;3q' | awk -F\" '{split($1, v, " ");printf("%s", v[5])}'` /usr/java11
  script:
    - ./ci/test.sh

build_and_test:jdk18:rdb4:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    SKIP_JAVA7_TEST: "true"
    TEST_LIST: "**"
    RDB_VERSION: $RDB4_VERSION
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk18:rdb4_native:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    SKIP_JAVA7_TEST: "true"
    TEST_LIST: "**"
    GDS_TYPE: "NATIVE"
    RDB_VERSION: $RDB4_VERSION
    REPORT_PREFIX: rdb4_native_jdk18_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk18:rdb4_fboonative:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    SKIP_JAVA7_TEST: "true"
    TEST_LIST: "**"
    GDS_TYPE: "FBOONATIVE"
    RDB_VERSION: $RDB4_VERSION
    REPORT_PREFIX: rdb4_fboonative_jdk18_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk18:rdb4_embedded:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    SKIP_JAVA7_TEST: "true"
    TEST_LIST: "**"
    GDS_TYPE: "EMBEDDED"
    RDB_VERSION: $RDB4_VERSION
    REPORT_PREFIX: rdb4_embedded_jdk18_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk18:rdb4_fbooembedded:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    SKIP_JAVA7_TEST: "true"
    TEST_LIST: "**"
    GDS_TYPE: "FBOOEMBEDDED"
    RDB_VERSION: $RDB4_VERSION
    REPORT_PREFIX: rdb4_fbooembedded_jdk18_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk18:rdb3:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    RDB_VERSION: $RDB3_VERSION
    SKIP_JAVA7_TEST: "false"
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    TEST_JAVA7_JVM: /usr/lib/jvm/jre-1.7.0/bin/java
    EXTRA_DEPENDENCIES: icu java-1.7.0-openjdk-headless
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk11:rdb3:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    RDB_VERSION: $RDB3_VERSION
    SKIP_JAVA7_TEST: "true"
    TEST_JAVA8_JVM: /usr/java11/bin/java
    TEST_LIST: "**"
    EXTRA_DEPENDENCIES: icu java-11-openjdk
    REPORT_PREFIX: jdk11_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:liberica_jdk8:rdb3:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    RDB_VERSION: $RDB3_VERSION
    SKIP_JAVA7_TEST: "true"
    TEST_JAVA8_JVM: /usr/lib/jvm/bellsoft-java8-runtime.x86_64/bin/java
    JDK_VER: 8-runtime
    TEST_LIST: "**"
    EXTRA_DEPENDENCIES: icu bellsoft-java8-runtime
    REPORT_PREFIX: liberica_jdk8_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:liberica_jdk11:rdb3:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    RDB_VERSION: $RDB3_VERSION
    SKIP_JAVA7_TEST: "true"
    TEST_JAVA8_JVM: /usr/lib/jvm/bellsoft-java11-runtime.x86_64/bin/java
    JDK_VER: 11-runtime
    TEST_LIST: "**"
    EXTRA_DEPENDENCIES: icu bellsoft-java11-runtime
    REPORT_PREFIX: liberica_jdk11_
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

build_and_test:jdk18:rdb2_6:
  <<: *build_and_test_template
  variables:
    JAVA_HOME: /usr/lib/jvm/jre-1.8.0
    RDB_VERSION: $RDB2_VERSION
    SKIP_JAVA7_TEST: "true"
    TEST_JAVA8_JVM: /usr/lib/jvm/jre-1.8.0/bin/java
    TEST_LIST: "**,!**/nativeoo/**"
    EXTRA_DEPENDENCIES: icu xinetd
  image:
    name: registry.red-soft.biz:5000/docker-images/rdbbuildenv:rdb4-3

deploy:internal:
  <<: *deploy_template
  stage: deploy
  script:
    - mvn $MAVEN_CLI_OPTS deploy -Pdeploy-internal -Dmaven.test.skip.exec -DreleaseHubBuildVersion=$VERSION
    - mvn $MAVEN_CLI_OPTS --non-recursive releasehub-build:publish -Pdeploy-internal -DreleaseHubBuildVersion=$VERSION

deploy:bintray:
 <<: *deploy_template
 stage: deploy
 script:
   - mvn $MAVEN_CLI_OPTS deploy -Pdeploy-bintray -Dmaven.test.skip.exec
 only:
   - tags
